name: Release product repository

on: workflow_call
     
permissions:
  contents: write

concurrency:
  group: '${{ github.workflow }}-${{ github.ref || github.head_ref }}'
  cancel-in-progress: true

env: 
  GA_VERSION: "main"
  GITHUB_USER: "datavisyn-bot"


jobs:
  release-repository:
    runs-on: ubuntu-20.04
    steps:
      - name: check actor
        if: ${{ !contains('["datavisyn-bot", "anita-steiner","dvvanessastoiber", "puehringer","dvdanielamoitzi", "thinkh"]', github.actor) }}
        run: |
          echo "you are not allowed to run this job!"
          exit 1
      - name: check branch
        if: ${{ !contains(github.ref, 'develop') }}
        run: |
          echo 'only the develop branches can be released.'
          exit 1  
      - uses: actions/checkout@v3
        with:
          token: ${{ secrets.DATAVISYN_BOT_REPO_TOKEN }}
      # checkout this workflow repository to get actions
      - uses: actions/checkout@v3
        with:
          repository: datavisyn/github-workflows
          ref: main
          path: ./tmp/github-workflows
      - uses: ./tmp/github-workflows/.github/actions/get-product-parameters
        id: get-parameters
        with:
          dv_customers: ${{ secrets.DV_CUSTOMERS }}
          repository_name: ${{ github.event.repository.name }}
          branch_name: ${{ github.ref }}
          time_zone: ${{ env.TIME_ZONE }}
      - name: delete tmp files
        run: |
          rm -rf ./tmp           
      - name: read known repositories
        id: get-known-repositories
        run: |
          if [[ ${{github.event.repository.private}} = true ]]; then
            curl -H 'Authorization: token ${{ secrets.DATAVISYN_BOT_REPO_TOKEN }}' \
              -H 'Accept: application/vnd.github.v4.raw' \
              -o known_repositories.json \
              -L https://raw.githubusercontent.com/datavisyn/github-maintenance/main/release/next_repositories_sources.json
          else
            curl -H 'Authorization: token ${{ secrets.DATAVISYN_BOT_REPO_TOKEN }}' \
              -H 'Accept: application/vnd.github.v4.raw' \
              -o known_repositories.json \
              -L https://raw.githubusercontent.com/datavisyn/github-maintenance/main/release/next_repositories_sources_public.json
          fi
          known_repositories=$(echo $(jq -c '.' ./known_repositories.json) | jq -R '.')
          echo ${known_repositories}
          rm ./known_repositories.json
          echo "::set-output name=known_repositories::$known_repositories"
      - name: check repository
        id: check-repository
        run: |
          repository=$(jq  -rc '.[] | select(.type == "web") | .repo' ./phovea_product.json)
          repository=$(echo "$repository" | sed -e 's|.*/||')
          known_repositories=${{ steps.get-known-repositories.outputs.known_repositories }}
          checked_repository="$(echo $known_repositories | jq -r '.' | jq --arg var $repository '.[$var]')"
          release_version="$(echo $checked_repository | jq -r '.version')"
          sub_app=${{ steps.get-parameters.outputs.known_repositories }}
          if [[ ! -z $sub_app ]] ; then
            release_version+="-${sub_app}"
          fi
          customer=${{ steps.get-parameters.outputs.customer }}
          if [[ $customer != "datavisyn" ]] ; then
            release_version+="-${customer}"
          fi
          generator_version="$(echo $known_repositories | jq -r '."generator-phovea" | .version')"
          new_branch_name=${{steps.get-parameters.outputs.image_tag2 }}
          new_branch_name=${new_branch_name/develop/"rc_$release_version"}
          main_branch_name=${new_branch_name/develop/"main"}
          echo ::set-output name=repository::${checked_repository}
          echo ::set-output name=release_version::${release_version}
          echo ::set-output name=generator_version::${generator_version}
          echo ::set-output name=new_branch_name::${new_branch_name}
          echo ::set-output name=main_branch_name::${main_branch_name}
      - name: create/get release branch
        run: |
          echo "create/get release branch"
          if git rev-parse --verify --quiet origin/${{ env.BRANCH_NAME }}; then
            echo "branch exists!"
            git checkout ${{ env.BRANCH_NAME }} 
          else
            echo "create branch"
            git checkout -b ${{ env.BRANCH_NAME }}
          fi
        env:
          BRANCH_NAME: ${{ steps.check-repository.outputs.new_branch_name }}          
      - name: prepare release
        run: |
          version=$(jq -r '.version' ./package.json)
          # change version in package.json
          npm_develop=git+ssh://git@github.com:phovea/generator-phovea#develop
          sed -i "s|\"generator-phovea\": \"$npm_develop\"|\"generator-phovea\": \"${{ steps.check-repository.outputs.generator_version }}\"|gI" ./package.json
          sed -i "s|\"version\": \"$version\"|\"version\": \"${{ steps.check-repository.outputs.release_version }}\"|gI" ./package.json
          cat ./package.json
          # change phovea_product
          # frontend
          known_repositories=${{ steps.get-known-repositories.outputs.known_repositories }}
          content="[{"
          name=$(jq  -rc '.[] | select(.type == "web") | .repo' ./phovea_product.json)
          name=$(echo "$name" | sed -e 's|.*/||')
          echo $name
          version="$(echo $known_repositories | jq -r --arg var $name '.[$var] | .version')"
          echo $version
          owner="$(echo $known_repositories | jq -r --arg var $name '.[$var] | .owner')"
          content+="\"type\": \"web\", \"name\": \"$name\", \"repo\": \"$owner/$name\", \"branch\": \"v$version\",   \"additional\": ["
          readarray -t my_array < <(jq  -rc '.[] | select(.type == "web") | .additional[] ' ./phovea_product.json)
          for additional in "${my_array[@]}"; do
            name=$(echo $additional | jq  -rc '.name')
            name=$(echo "$name" | sed -e 's|.*/||')
            echo $name
            version="$(echo $known_repositories | jq -r --arg var $name '.[$var] | .version')"
            echo $version
            owner="$(echo $known_repositories | jq -r --arg var $name '.[$var] | .owner')"
            content+="{\"name\": \"$name\", \"repo\": \"$owner/$name\", \"branch\": \"v$version\"},"
          done
          content=${content::-1}
          content+="]},"
          # backend
          content+="{"
          name=$(jq  -rc '.[] | select(.type == "api") | .repo' ./phovea_product.json)
          name=$(echo "$name" | sed -e 's|.*/||')
          echo $name
          version="$(echo $known_repositories | jq -r --arg var $name '.[$var] | .version')"
          echo $version
          owner="$(echo $known_repositories | jq -r --arg var $name '.[$var] | .owner')"
          content+="\"type\": \"api\", \"name\": \"$name\", \"repo\": \"$owner/$name\", \"branch\": \"v$version\",   \"additional\": ["
          readarray -t my_array < <(jq  -rc '.[] | select(.type == "api") | .additional[]' ./phovea_product.json)
          for additional in "${my_array[@]}"; do
            echo "$additional"
            name=$(echo $additional | jq  -rc '.name')
            name=$(echo "$name" | sed -e 's|.*/||')
            echo $name
            version="$(echo $known_repositories | jq -r --arg var $name '.[$var] | .version')"
            echo $version
            owner="$(echo $known_repositories | jq -r --arg var $name '.[$var] | .owner')"
            content+="{\"name\": \"$name\", \"repo\": \"$owner/$name\", \"branch\": \"v$version\"},"
          done
          content=${content::-1}
          content+="]}]"          
          echo -e $content > ./phovea_product2.json
          jq '.' ./phovea_product2.json > ./phovea_product.json
          rm ./phovea_product2.json
          #change version of github action references
          find ./.github/workflows/ -name '*.yml' -exec sed -i "s/@main/@$GA_VERSION/g" {} \;
      - name: setup git config
        run: |
          git config user.name "${{ github.actor }}"
          git config user.email "<>"          
      - name: push branch
        run: |
          echo "push branch"
          git commit -am "[skip ci]Prepare release ${{ steps.check-repository.outputs.release_version }}"
          git push origin ${{ steps.check-repository.outputs.new_branch_name }}
      - name: trigger build
        uses: datavisyn/github-action-trigger-workflow@v1
        with:
          owner: ${{ github.repository_owner }}
          repo: ${{ github.event.repository.name }}
          github_token: ${{ secrets.DATAVISYN_BOT_REPO_TOKEN }}
          workflow_file_name: "build.yml"
          ref: "${{ steps.check-repository.outputs.new_branch_name }}"
          github_user: ${{ env.GITHUB_USER }}
      - name: create pull request
        id: create-pr
        uses: octokit/request-action@v2.x
        with:
          route: POST /repos/{owner}/{repo}/pulls
          owner: ${{ github.repository_owner }}
          repo: ${{ github.event.repository.name }}
          title: "Release ${{ steps.check-repository.outputs.release_version }}"
          body: 'This pr will create version ${{ steps.check-repository.outputs.release_version }}'
          head: "${{ steps.check-repository.outputs.new_branch_name }}"
          base: "${{ steps.check-repository.outputs.main_branch_name }}"
          draft: false
        env:
          GITHUB_TOKEN: ${{ secrets.DATAVISYN_BOT_REPO_TOKEN }}
      - name: check pr status
        if: ${{ steps.create-pr.outputs.status != 201 }}
        run: |
          echo "something went wrong with the pr"
          echo "data: ${{ steps.create-pr.outputs.data }}"
          echo "status: ${{ steps.create-pr.outputs.status }}"
          exit 1                                  
