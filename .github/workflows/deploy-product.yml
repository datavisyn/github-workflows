name: deploy-product

on:
  workflow_call:
    secrets:
      DATAVISYN_BOT_REPO_TOKEN:
        required: true
      DV_CUSTOMERS:
        required: true
      DV_DEVOPS:
        required: true
      DV_QMS:
        required: true
      DV_AWS_ECR_REGISTRY:
        required: false
      DV_BOT_USER:
        required: true
    inputs:
      stage:
        description: "stage that should be deployed (develop|qa|production)"
        required: true
        type: string
      customer:
        description: "customer for that the app should be deployed"
        required: true
        type: string

permissions:
  id-token: write
  contents: read

concurrency:
  group: '${{ github.workflow }}-${{ github.ref || github.head_ref }}'
  cancel-in-progress: true

env:
  GA_VERSION: "main"
  WORKFLOW_BRANCH: "new_deployment"

jobs:
  deploy:
    runs-on: ubuntu-20.04
    steps:
      - name: check actor
        run: |
          dv_devops=$_DV_DEVOPS
          dv_qms=$_DV_QMS
          actor=$GITHUB_ACTOR
          mapfile -t array1 < <(echo "${dv_devops}" | tr ',' "\n")
          mapfile -t array2 < <(echo "${dv_qms}" | tr ',' "\n")
          array1+=("${array2[@]}")
          for e in "${array1[@]}"; do
            if [[ "$e" == "$actor" ]] ; then
              exit 0
            fi
          done
          echo "you are not allowed to run this job!"
          exit 1
        env:
          _DV_DEVOPS: ${{ secrets.DV_DEVOPS }}
          _DV_QMS: ${{ secrets.DV_QMS }}
          GITHUB_ACTOR: ${{ github.actor }}
      # checkout repo to get package.json
      - uses: actions/checkout@v3
      # checkout this workflow repository to get actions
      - uses: actions/checkout@v3
        with:
          repository: datavisyn/github-workflows
          ref: ${{ env.WORKFLOW_BRANCH }}
          path: ./tmp/github-workflows
      - uses: ./tmp/github-workflows/.github/actions/get-single-product-parameters
        id: get-parameters
        with:
          dv_customers: ${{ secrets.DV_CUSTOMERS }}
          repository_name: ${{ github.event.repository.name }}
          branch_name: ${{ github.ref_name }}
          time_zone: ${{ env.TIME_ZONE }}
      - name: trigger deployment
        uses: datavisyn/github-action-trigger-workflow@v1
        with:
          owner: "datavisyn"
          repo:  "infrastructure-k8s"
          github_token: ${{ secrets.DATAVISYN_BOT_REPO_TOKEN }}
          workflow_file_name: "deploy-app.yml"
          ref: ${{ env.WORKFLOW_BRANCH }}
          github_user: ${{ secrets.DV_BOT_USER }}
          client_payload: '{ "app": "${{ steps.get-parameters.outputs.app }}", "customer": "${{ inputs.customer }}", "stage": "${{ inputs.stage }}", "sub_app": "${{ steps.get-parameters.outputs.sub_app }}", "branch": "${{ steps.get-parameters.outputs.image_tag2 }}" }'
