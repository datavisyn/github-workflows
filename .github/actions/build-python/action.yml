name: Build and Publish Python Repositories

inputs:
  python_version:
    description: "python version to use"
    default: "3.10"
    required: true
    type: string
  publish:
    description: "true, if the package should be published to npm; otherwise false"
    default: false
    required: true
    type: boolean
  pypi_registry:
    description: "registry where to publish python package"
    default: "https://pypi.org/pypi"
    required: true
    type: string
  pypi_username:
    description: "username for python registry"
    default: "admin"
    required: true
    type: string
  pypi_password:
    description: "passwort for python registry"
    default: "admin"
    required: true
    type: string
  github_ro_token:  
    description: "github read-only token"
    default: "admin"
    required: true
    type: string
runs:
  using: "composite"
  steps:      
    - name: Set up python ${{ inputs.python_version }}
      uses: actions/setup-python@v3
      with:
        python-version: ${{ inputs.python_version }}
    - name: Show python and pip version
      run: |
        python --version
        pip --version
    - name: Git config
      if: "${{ env.GITHUB_TOKEN != '' }}"
      run: git config --global url."https://${{ secrets.GITHUB_TOKEN }}@github".insteadOf https://github
      env: 
        GITHUB_TOKEN: ${{ inputs.github_ro_token }}           
    - name: Install python dependencies
      run: make develop
    - name: Show installed pip packages
      run: pip list || true
    - name: Linting
      run: make lint check-format                  
    - name: Run tests
      run: make test
    - name: Publish to pip registry
      if: ${{ inputs.publish && inputs.publish != 'false' }}
      run: |
          echo "publish"
          pip install twine
#          echo -e "[pypi]" >> ~/.pypirc
#          echo -e "repository = $PYPI_REPOSITORY" >> ~/.pypirc
#          echo -e "username = $PYPI_USERNAME" >> ~/.pypirc
#          echo -e "password = $PYPI_PASSWORD" >> ~/.pypirc
#          twine upload dist_python/*
      env: 
        PYPI_REPOSITORY: ${{ inputs.pypi_registry }}
        PYPI_USERNAME: ${{ inputs.pypi_username }}
        PYPI_PASSWORD: ${{ inputs.pypi_password }}      
